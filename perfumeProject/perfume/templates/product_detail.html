{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ product.name }} - 제품 상세</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    
    <style>
        .action-buttons form {
            display: inline-block; /* 폼이 줄바꿈되지 않고 나란히 표시되도록 함 */
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1><a href="/" style="text-decoration: none; color: #555;">Perform</a></h1>
            <div class="header-nav">
                <a href="#">여성향수</a>
                <a href="#">남성향수</a>
                <a href="#">향수공병</a>
            </div>
        </header>

        <main class="product-info">
            
            <section class="product-image-section">
                <img src="{% static 'images/'|add:product.main_image_filename %}" alt="{{ product.name }}" class="product-main-image">
            </section>

            <section class="product-details-section">
                <h2 class="product-name">{{ product.name }}</h2>
                
                <div class="price-group">
                    <span class="original-price">{{ product.original_price }}원</span>
                    <span class="sale-price">{{ product.sale_price }}원</span>
                </div>
                
                <div class="product-meta">
                    <p><strong>특이사항</strong> {{ product.special_notes }}</p>
                    <p><strong>쿠폰적용가격</strong> <span style="color: #e63946; font-weight: 700;">{{ product.promotion_price_info }}</span></p>
                    
                    <p><strong>색상</strong></p>
                    <div class="color-options">
                        {% for color_name in product.options %}
                            <div class="color-option color-{{ color_name|slugify }}" title="{{ color_name }}"></div>
                        {% endfor %}
                    </div>
                </div>

                <div class="quantity-selector">
                    <strong>수량</strong>
                    <button type="button" onclick="changeQuantity(-1)">-</button>
                    <input type="text" id="quantity" value="1" readonly>
                    <button type="button" onclick="changeQuantity(1)">+</button>
                </div>

                <div class="total-price">
                    총 상품 금액: <span id="total-price-display">{{ product.sale_price }}</span>원
                </div>
                
                <div class="action-buttons">
                    
                    <form method="POST" action="{% url 'perfume:add_to_cart' %}">
                        {% csrf_token %}
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <input type="hidden" name="quantity" id="form-quantity-cart" value="1">
                        
                        <button type="submit" class="add-to-cart-btn">장바구니</button>
                    </form>

                    <form method="POST" action="{% url 'perfume:order_now' %}">
                        {% csrf_token %}
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <input type="hidden" name="quantity" id="form-quantity-order" value="1">
                        
                        <button type="submit" class="buy-now-btn">주문하기</button>
                    </form>
                </div>

            </section>
        </main>

        <nav class="tabs">
            <div class="tab-item active" onclick="showTab('detail')">상세정보</div>
            <div class="tab-item" onclick="showTab('review')">구매후기 (0)</div>
        </nav>

        <section class="tab-content">
            <div id="tab-pane-detail" class="tab-pane active">
                <img src="{{ product.detail_image.url }}" alt="상세 정보" class="product-detail-image">
            </div>
            <div id="tab-pane-review" class="tab-pane">
                <p>구매후기가 아직 없습니다.</p>
            </div>
        </section>

    </div>

    <script>
        const salePrice = {{ product.sale_price }}
        const quantityInput = document.getElementById('quantity');
        const totalPriceDisplay = document.getElementById('total-price-display');

        // 수량 조절 함수
        function changeQuantity(amount) {
            let currentQuantity = parseInt(quantityInput.value);
            if (currentQuantity + amount > 0) {
                currentQuantity += amount;
                quantityInput.value = currentQuantity;
                updateTotalPrice(currentQuantity);

                // ★★★ 수정: 수량 변경 시 2개의 폼(form) 안의 숨겨진 quantity 값도 실시간 업데이트 ★★★
                document.getElementById('form-quantity-cart').value = currentQuantity;
                document.getElementById('form-quantity-order').value = currentQuantity;
            }
        }

        // 총 가격 업데이트
        function updateTotalPrice(quantity) {
            const newTotal = (salePrice * quantity).toLocaleString('ko-KR');
            totalPriceDisplay.textContent = newTotal;
        }

        // 탭 기능 함수
        function showTab(tabName) {
            // 모든 탭 내용 숨기기
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            // 모든 탭 버튼 비활성화
            document.querySelectorAll('.tab-item').forEach(item => {
                item.classList.remove('active');
            });

            // 선택된 탭 내용 보여주기
            document.getElementById(`tab-pane-${tabName}`).classList.add('active');
            // 선택된 탭 버튼 활성화
            document.querySelector(`.tab-item[onclick="showTab('${tabName}')"]`).classList.add('active');
        }
    </script>
</body>
</html>